<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Austin Hoover">
<meta name="dcterms.date" content="2024-10-13">

<title>The impact of phase space correlations on the beam dynamics in linear accelerators – Accelerated Inquiry</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DLC4C8LZFB"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-DLC4C8LZFB', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Accelerated Inquiry</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../notes/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-initial-beam" id="toc-the-initial-beam" class="nav-link active" data-scroll-target="#the-initial-beam">The initial beam</a></li>
  <li><a href="#parmteq-vs.-reality" id="toc-parmteq-vs.-reality" class="nav-link" data-scroll-target="#parmteq-vs.-reality">PARMTEQ vs.&nbsp;reality</a></li>
  <li><a href="#how-important-are-6d-correlations-in-the-sns-linac" id="toc-how-important-are-6d-correlations-in-the-sns-linac" class="nav-link" data-scroll-target="#how-important-are-6d-correlations-in-the-sns-linac">How important are 6D correlations in the SNS linac?</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The impact of phase space correlations on the beam dynamics in linear accelerators</h1>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Austin Hoover </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 13, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Almost one year ago, CERN hosted the “68th ICFA Advanced Beam Dynamics Workshop on High-Intensity and High-Brightness Hadron Beams”, also known as “HB”. I gave a talk on our work at the SNS Beam Test Facility (BTF). I intended to share that work on this blog, but never got around to it. Better late than never:</p>
<section id="the-initial-beam" class="level2">
<h2 class="anchored" data-anchor-id="the-initial-beam">The initial beam</h2>
<p>I usually start these talks by reviewing the LEDA (Low Energy Test Accelerator) experiment at Los Alamos National Laboratory <span class="citation" data-cites="Allen_2002">&nbsp;[<a href="#ref-Allen_2002" role="doc-biblioref">1</a>]</span>. LEDA was a proton source followed by 50 quadrupole magnets arranged in an alternating focus-defocus pattern (FODO). A series of experiments recorded the one-dimensional particle distribution at the end of the accelerator for different sets of quadrupole strengths (optics). In some cases, simulations reproduced the measurements in regions of high particle density, i.e., the beam core. But no simulation reproduced the low-density “tails” or “halo”.</p>
<div id="fig-leda" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-leda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_leda.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Measured and simulated beam profiles in the LEDA experiment @Qiang_2002."><img src="figures/fig_leda.png" class="img-fluid quarto-figure quarto-figure-left figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-leda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Measured and simulated beam profiles in the LEDA experiment <span class="citation" data-cites="Qiang_2002">&nbsp;[<a href="#ref-Qiang_2002" role="doc-biblioref">2</a>]</span>.
</figcaption>
</figure>
</div>
<p>Halo formation is driven by space charge (electric forces between particles). Thus, the discrepancies might have been due to an inaccurate initial distribution in 6D phase space. (They only estimated second-order moments.) On the other hand, errors in the accelerator model might have been to blame. Reproducing halo-level features requires modeling a delicate interplay between applied and self-generated fields.</p>
<p>At the BTF, we’re trying to improve on LEDA’s results. Our primary advantage is a suite of novel phase space diagnostics. One of these diagnostics images the 6D phase space distribution at the beginning of the lattice <span class="citation" data-cites="Cathey_2018">&nbsp;[<a href="#ref-Cathey_2018" role="doc-biblioref">3</a>]</span>; another diagnostic measures the beam halo in 2D phase space at the end of the lattice <span class="citation" data-cites="Aleksandrov_2021">&nbsp;[<a href="#ref-Aleksandrov_2021" role="doc-biblioref">4</a>]</span>. In the first half of my postdoc, I focused on measurements of the distribution at both locations; see conference reports <a href="https://accelconf.web.cern.ch/napac2022/papers/frxd3.pdf">here</a> and <a href="https://accelconf.web.cern.ch/ipac2023/pdf/WEPA028.pdf">here</a>. We observed major differences between our predictions and measurements. One culprit may have been the paperclip layout of the beamline: bending 180 degrees generated dispersion, and we were unsure if we were modeling the dipole magnets correctly. In any case, linacs do not typically bend, so we upgraded the BTF to a new straight layout. This took several months.</p>
<p>During the upgrade, I examined a question that could be partially answered by computer simulations: How important is the initial 6D phase space structure? In other words, if we ignore correlations between some dimensions, how will this affect the beam dynamics? An easy way to answer this question is to use the measured 6D distribution. However, 6D measurements currently have low resolution (<span class="math inline">\(\approx 10^6\)</span> points) and low dynamic range (<span class="math inline">\(\approx 10^1\)</span>); it’s unclear if these values are sufficient to predict halo-level features.</p>
<p>There’s another way to generate the initial beam which avoids direct 6D measurements. The initial beam is not really the initial beam; it’s the beam at the location labeled “First Emittance Station” in <a href="#fig-btf-01" class="quarto-xref">Figure&nbsp;2</a>.</p>
<div id="fig-btf-01" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-btf-01-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_btf_01.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: The SNS Beam Test Facility (BTF)."><img src="figures/fig_btf_01.png" class="img-fluid quarto-figure quarto-figure-left figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-btf-01-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: The SNS Beam Test Facility (BTF).
</figcaption>
</figure>
</div>
<p>The beam emerges from the source as a continuous stream of ions. The RFQ (Radio Frequency Quadrupole) accelerates the beam to 2.5 MeV and converts the continuous stream to a train of <em>bunches</em>. Before the RFQ, the longitudinal distribution is spatially uniform with a tiny energy spread; thus, defining the initial beam would only require a 4D (transverse) phase space measurement. However, we would then need to simulate the journey through the RFQ, which involves complex dynamics over hundreds of focusing periods with strong space charge. So, we opted for the more difficult 6D measurement after the RFQ.</p>
<p>Still, we could try this approach. We don’t have any diagnostics before the RFQ (there’s no room), but we do have 2D diagnostics at a dedicated Ion Source Test Stand. The ion source is different than the one in BTF, but it should produce a similar distribution. We took some old measurement data of a 50 mA beam in the Ion Source Test Stand and tracked it through the RFQ. The RFQ code (PARMTEQ) predicted a 42 mA beam current, but the real RFQ generated 26 mA. That’s a huge unexplained discrepancy! We’re still unsure what caused this because we can’t peer inside the RFQ. Unphased, we artificially changed the beam current to 26 mA in the simulation and tracked it to the first measurement station.</p>
<div id="fig-btf-02" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-btf-02-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_btf_02.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;3: PARMTEQ model bunch generation. An initial 2D measurement is transported through the RFQ using PARMTEQ and through the first section of the BTF using PyORBIT."><img src="figures/fig_btf_02.png" class="img-fluid quarto-figure quarto-figure-left figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-btf-02-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: PARMTEQ model bunch generation. An initial 2D measurement is transported through the RFQ using PARMTEQ and through the first section of the BTF using PyORBIT.
</figcaption>
</figure>
</div>
</section>
<section id="parmteq-vs.-reality" class="level2">
<h2 class="anchored" data-anchor-id="parmteq-vs.-reality">PARMTEQ vs.&nbsp;reality</h2>
<p>The PARMTEQ simulations generate a fully correlated 6D bunch without a direct measurement. The tradeoff is that we’re unsure how realistic this distribution is. We know PARMTEQ gets the basic physics correct, but the model contains various approximations, such as an assumed cylindrical symmetry when solving the Poisson equation. The only way to check is via direct measurements.</p>
<p>A previous paper found reasonable agreement in high-dimensional slices <span class="citation" data-cites="Ruisard_2020">&nbsp;[<a href="#ref-Ruisard_2020" role="doc-biblioref">5</a>]</span>; I set out to perform a more comprehensive comparison. A year before HB, we performed 5D measurements of the initial beam, mapping the density as a function of <span class="math inline">\(x\)</span>, <span class="math inline">\(p_x\)</span>, <span class="math inline">\(y\)</span>, <span class="math inline">\(p_y\)</span>, and <span class="math inline">\(p_z\)</span> <span class="citation" data-cites="Hoover_2022">&nbsp;[<a href="#ref-Hoover_2022" role="doc-biblioref">6</a>]</span>. The missing dimension, <span class="math inline">\(z\)</span>, is strongly correlated with <span class="math inline">\(p_z\)</span>, so most features are visible from the five measured variables. 5D measurements are much faster than 6D measurements because we can image two dimensions at once on a screen (and because there is one less dimension to measure). Because of the boosted resolution and dynamic range, we can visualize sharper features in low-density regions of phase space.</p>
<p>Here are the 1D and 2D projections of the measured and predicted (PARMTEQ) distributions. Note that I use <span class="math inline">\(x' = p_x / p_z\)</span> and <span class="math inline">\(y' = p_y / p_z\)</span> for the transverse momentum. I also use <span class="math inline">\(w\)</span> instead of <span class="math inline">\(p_z\)</span>, where <span class="math inline">\(w = E - E_0\)</span> is the deviation from the design energy.</p>
<div id="fig-corner" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-corner-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_01a.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;4: Measured (black) and predicted (red) phase space distributions in the BTF."><img src="figures/fig_01a.png" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:80.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-corner-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Measured (black) and predicted (red) phase space distributions in the BTF.
</figcaption>
</figure>
</div>
<p>These contours are on a logarithmic scale, showing three orders of magnitude in density. It’s not a total disaster, but it’s kinda bad. Particularly troublesome is the <span class="math inline">\(x\)</span>-<span class="math inline">\(p_x\)</span> distribution, which is much wider than measured. However, look what happens after a linear transformation:</p>
<div id="fig-corner-normalized" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-corner-normalized-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_01b.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5: Normalized phase space distribution."><img src="figures/fig_01b.png" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:80.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-corner-normalized-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Normalized phase space distribution.
</figcaption>
</figure>
</div>
<p>Much better! All I did was normalize both distributions to identity covariance so that</p>
<p><span class="math display">\[\begin{equation}
\Sigma =
\begin{bmatrix}
\langle xx   \rangle &amp; \langle xp_x   \rangle &amp; \langle xy   \rangle &amp; \langle xp_y   \rangle &amp; \langle x p_z  \rangle \\
\langle xp_x \rangle &amp; \langle p_xp_x \rangle &amp; \langle yp_x \rangle &amp; \langle p_xp_y \rangle &amp; \langle p_xp_z \rangle \\
\langle xy   \rangle &amp; \langle yp_x   \rangle &amp; \langle yy   \rangle &amp; \langle yp_y   \rangle &amp; \langle y p_z  \rangle \\
\langle xp_y \rangle &amp; \langle p_xp_y \rangle &amp; \langle yp_y \rangle &amp; \langle p_yp_y \rangle &amp; \langle p_yp_z \rangle \\
\langle xp_z \rangle &amp; \langle p_xp_z \rangle &amp; \langle yp_z \rangle &amp; \langle p_yp_z \rangle &amp; \langle p_zp_z \rangle
\end{bmatrix}
=
\begin{bmatrix}
1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}\]</span></p>
<p>From now on, I’ll let <span class="math inline">\(x\)</span>, <span class="math inline">\(p_x\)</span>, <span class="math inline">\(y\)</span>, <span class="math inline">\(p_y\)</span>, and <span class="math inline">\(p_z\)</span> refer to these “normalized” coordinates. <a href="#fig-corner-normalized" class="quarto-xref">Figure&nbsp;5</a> shows that the distributions are similar, up to a linear transformation. PARMTEQ has gotten the nonlinear stuff right, even though it predicts a much larger transmission than measured in the real RFQ. This suggests that losses occur very early in the bunch formation process and have little impact on the higher-order distribution moments.</p>
<p><a href="#fig-corner-normalized" class="quarto-xref">Figure&nbsp;5</a> does <em>not</em> prove that the distributions are identical in the full five-dimensional space. There are two higher-dimensional correlations we’ve identified in our 5D measurement. First, we know the energy distribution (<span class="math inline">\(p_z\)</span>) depends on the transverse coordinates. The energy distribution is bimodal near the transverse core but unimodal outside the core. You can’t see this in the 1D and 2D projections. One way to visualize the relationship is to use “elliptical slices”. <a href="#fig-slice-shell" class="quarto-xref">Figure&nbsp;6</a> shows the <span class="math inline">\(p_z\)</span> distribution of particles within a radial band in <span class="math inline">\(x\)</span>-<span class="math inline">\(p_x\)</span>-<span class="math inline">\(y\)</span>-<span class="math inline">\(p_y\)</span> space. The model bunch has the correct relationship between energy and transverse radius.</p>
<div id="fig-slice-shell" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-slice-shell-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_slice_shell.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;6: Energy distribution within ellipsoidal shells in the transverse plane."><img src="figures/fig_slice_shell.png" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-slice-shell-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Energy distribution within ellipsoidal shells in the transverse plane.
</figcaption>
</figure>
</div>
<p>The above feature develops somewhere in the RFQ. We’ve also measured hollowing in the 3D space <span class="math inline">\(x\)</span>-<span class="math inline">\(y\)</span>-<span class="math inline">\(z\)</span>. This feature develops after the RFQ. As the beam transitions from strong to weak focusing at the RFQ exit, space charge launches a density wave that flattens the initially peaked distribution to a more uniform and, eventually, hollow distribution. The beam freely expands in the longitudinal plane, creating a strong linear correlation such that (<span class="math inline">\(z \approx p_z\)</span>). Again, we see similar features in the model bunch in <a href="#fig-slice-pz" class="quarto-xref">Figure&nbsp;7</a>. We conclude that the RFQ simulation reproduces nearly all measured features in both low-dimensional and high-dimensional phase space, up to a linear transformation.</p>
<div id="fig-slice-pz" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-slice-pz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_slice_pz.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;7: Transverse charge distribution (x-y) as a function of energy (p_z)."><img src="figures/fig_slice_pz.png" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-slice-pz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Transverse charge distribution (<span class="math inline">\(x\)</span>-<span class="math inline">\(y\)</span>) as a function of energy (<span class="math inline">\(p_z\)</span>).
</figcaption>
</figure>
</div>
<p>This result is interesting and not too obvious; I’d like to include it in a future publication alongside a more detailed study of the beam dynamics in the RFQ. The result is also useful because linear correlations are easy to measure. We can just map the PARMTEQ bunch to the measured linear correlations, and, <em>voila</em>, we have a fully correlated 6D distribution that should be very similar to the real distributioin.</p>
</section>
<section id="how-important-are-6d-correlations-in-the-sns-linac" class="level2">
<h2 class="anchored" data-anchor-id="how-important-are-6d-correlations-in-the-sns-linac">How important are 6D correlations in the SNS linac?</h2>
<p>We can also use the model bunch to examine what could happen in the SNS linac. Predicting beam loss in the SNS is our ultimate goal. This is much more difficult than our task in the BTF: the SNS is around 500 meters long compared to 10 meters in the BTF; the SNS accelerates the beam using hundreds of RF cavities, while the BTF has no acceleration; we are much less certain about the accelerator parameters; etc. <a href="#fig-sns" class="quarto-xref">Figure&nbsp;8</a> gives a sense of scale. Still, there is nothing stopping us from assuming, for the sake of argument, that our linac model is correct. We can hypothesize that our physics model is a reasonable approximation of the real world. For example, most people believe the particle-in-cell (PIC) method captures the effect of space charge. We can also imagine a world in which the linac parameters — quadrupole strengths, rf cavity phases, etc. — are equal to the simulation parameters. Finally, in this hypothetical world, we can assume the initial distribution is a linear transformation of the “model” bunch generated by PARMTEQ.</p>
<div id="fig-sns" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_sns.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;8: Diagram of the SNS accelerator. The linac is around 400 meters long."><img src="figures/fig_sns.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Diagram of the SNS accelerator. The linac is around 400 meters long.
</figcaption>
</figure>
</div>
<p>We can now ask how changes to the initial bunch propagate down in the linac. We’re particularly interested in cross-plane correlations. What if we only knew the <em>projected</em> density onto each 2D phase space: <span class="math inline">\(f(x, p_x)\)</span>, <span class="math inline">\(f(y, p_y)\)</span>, and <span class="math inline">\(f(z, p_z)\)</span>? Without additional information, the only logical 6D distribution compatible with these projections is the product of the 2D distributions (the distribution that maximizes entropy):</p>
<p><span id="eq-product"><span class="math display">\[
\begin{equation}
f(x, p_x, y, p_y, z, p_z) = f(x, p_x) f(y, p_y) f(z, p_z).
\end{equation}
\tag{1}\]</span></span></p>
<p>We’ll refer to the bunch in <a href="#eq-product" class="quarto-xref">Equation&nbsp;1</a> as <em>decorrelated</em>. All cross-plane correlations, including higher-order correlations, vanish in the decorrelated bunch. To decorrelated the bunch, we simply shuffle the particle indices:</p>
<p><span id="eq-decorr"><span class="math display">\[
\begin{equation}
\begin{aligned}
    \{ x_i, {p_x}_i \} &amp;\rightarrow \{ x_i, {p_x}_i \}, \\
    \{ y_i, {p_y}_i \} &amp;\rightarrow \{ y_j, {p_y}_j \}, \\
    \{ z_i, {p_z}_i \} &amp;\rightarrow \{ z_k, {p_z}_k \},
\end{aligned}
\end{equation}
\tag{2}\]</span></span></p>
<p>where <span class="math inline">\(i\)</span>, <span class="math inline">\(j\)</span>, and <span class="math inline">\(k\)</span> are random permutations of the indices.</p>
<p>We tracked these two bunches (correlated and decorrelated) through the first section of the linac in our PyORBIT model and compared the trajectories. This isn’t new: my colleague did this in 2021, finding that the two beams diverged in their rms sizes (<a href="#fig-ipac" class="quarto-xref">Figure&nbsp;9</a>).</p>
<div id="fig-ipac" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ipac-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_ipac.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure&nbsp;9: RMS beam size evolution for a correlated/decorrelated initial beam in the SNS linac. Presented at IPAC (2021)."><img src="figures/fig_ipac.png" class="img-fluid quarto-figure quarto-figure-left figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ipac-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: RMS beam size evolution for a correlated/decorrelated initial beam in the SNS linac. Presented at IPAC (2021).
</figcaption>
</figure>
</div>
<p>I planned to continue these studies and find out exactly how the 6D phase space correlations influenced the beam dynamics, especially halo formation. When I reproduced <a href="#fig-ipac" class="quarto-xref">Figure&nbsp;9</a>, though, I noticed something strange. The rms bunch length (<span class="math inline">\(z\)</span>) spiked halfway through the simulation.</p>
<div id="fig-wrong" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-wrong-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_wrong.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;10: Some particles are lagging behind the bunch…"><img src="figures/fig_wrong.png" class="img-fluid quarto-figure quarto-figure-left figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wrong-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Some particles are lagging behind the bunch…
</figcaption>
</figure>
</div>
<p>The phase space distributions at these locations showed that some particles were falling <em>way</em> behind the bunch. Eventually, transverse apertures removed these particles from the simulation. It doesn’t make sense to keep these particles in the bunch, so I added energy and phase apertures throughout the lattice to remove particles as soon as they deviated from the synchronous coordinates. Longitudinal apertures ensured a well-behaved rms bunch length, but I no longer saw any differences in the transverse bunch sizes.</p>
<div id="fig-corr" class="quarto-float quarto-figure quarto-figure-left anchored" data-fig-align="left">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-corr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_corr.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure&nbsp;11: RMS beam sizes after adding longitudinal apertures. Compare to Figure&nbsp;9."><img src="figures/fig_corr.png" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:75.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-corr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: RMS beam sizes after adding longitudinal apertures. Compare to <a href="#fig-ipac" class="quarto-xref">Figure&nbsp;9</a>.
</figcaption>
</figure>
</div>
<p>What’s going on? It turns out that the lost particles were affecting the space charge calculation. To compute the beam’s electric field, we solve the Poisson equation on a grid:</p>
<p><span class="math display">\[\begin{equation}
\nabla \cdot \nabla \phi(x, y, z) = \frac{ \rho(x, y, z) } {\epsilon_0},
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\phi\)</span> is the electric potential and <span class="math inline">\(\rho\)</span> is the charge density. In PyORBIT, the grid expands to include all particles. In <a href="#fig-wrong" class="quarto-xref">Figure&nbsp;10</a>, the grid would expand in the middle plot to include the <span class="math inline">\(z\)</span> coordinates behind the bunch. This would leave almost all particles in one <span class="math inline">\(z\)</span> bin, giving an inaccurate charge density and space charge forces.</p>
<p>So that’s settled. But it also raises the question: do cross-plane correlations matter <em>at all</em>? <a href="#fig-corr" class="quarto-xref">Figure&nbsp;11</a> shows that the one-dimensional beam density is independent of the initial cross-plane correlations, even at the level of beam halo. Thus the answer is no: according to our model, cross-plane correlations do not affect the beam dynamics in the SNS. The more detailed view in <a href="#fig-tumble" class="quarto-xref">Figure&nbsp;12</a> shows that the differences between the distributions disappear quickly, within a few meters. You can see the hollow initial <span class="math inline">\(z\)</span> distribution in the 1D lineout compared to the peaked <span class="math inline">\(z\)</span> distribution; this represents a correlation because the distribution is only hollow near <span class="math inline">\(x = y = p_x = p_y = 0\)</span>. The lineouts merge soon after acceleration begins. The distributions are <em>both</em> highly correlated by the end of the figure.</p>
<div id="fig-tumble" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tumble-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/fig_tumble.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure&nbsp;12: Longitudinal phase space evolution in the linac. Each plot is the longitudinal phase space (z-p_z) distribution within a 4D ball in the transverse plane. 1D lineouts onto the z axis are plotted on the bottom row. Blue = correlated, red = decorrelated initial bunch."><img src="figures/fig_tumble.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tumble-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Longitudinal phase space evolution in the linac. Each plot is the longitudinal phase space (<span class="math inline">\(z\)</span>-<span class="math inline">\(p_z\)</span>) distribution within a 4D ball in the transverse plane. 1D lineouts onto the <span class="math inline">\(z\)</span> axis are plotted on the bottom row. Blue = correlated, red = decorrelated initial bunch.
</figcaption>
</figure>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>I think these findings are significant. It appears that measuring three orthogonal 2D projections of the 6D distribution can lead to the same predictions as direct 6D measurements. If this is true, we’ll need to direct our attention to the accelerator and physics models in our simulations. Of course, all of this needs experimental validation. Measurements at the BTF will serve as important benchmarks.</p>
<p>Here is the conference <a href="https://accelconf.web.cern.ch/hb2023/papers/tuc1c2.pdf">paper</a> and <a href="https://accelconf.web.cern.ch/hb2023/talks/tuc1c2_talk.pdf">slides</a>. <a href="https://accelconf.web.cern.ch/hb2023/">Here</a> are the full conference proceedings.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="0" role="list">
<div id="ref-Allen_2002" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">C. K. Allen et al., <em><a href="https://doi.org/10.1103/PhysRevLett.89.214802">Beam-Halo Measurements in High-Current Proton Beams</a></em>, Phys. Rev. Lett. <strong>89</strong>, 214802 (2002).</div>
</div>
<div id="ref-Qiang_2002" class="csl-entry" role="listitem">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">J. Qiang, P. L. Colestock, D. Gilpatrick, H. V. Smith, T. P. Wangler, and M. E. Schulze, <em><a href="https://doi.org/10.1103/PhysRevSTAB.5.124201">Macroparticle Simulation Studies of a Proton Beam Halo Experiment</a></em>, Phys. Rev. ST Accel. Beams <strong>5</strong>, 124201 (2002).</div>
</div>
<div id="ref-Cathey_2018" class="csl-entry" role="listitem">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">B. Cathey, S. Cousineau, A. Aleksandrov, and A. Zhukov, <em><a href="https://doi.org/10.1103/PhysRevLett.121.064804">First Six Dimensional Phase Space Measurement of an Accelerator Beam</a></em>, Phys. Rev. Lett. <strong>121</strong>, 064804 (2018).</div>
</div>
<div id="ref-Aleksandrov_2021" class="csl-entry" role="listitem">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">A. Aleksandrov, S. Cousineau, K. Ruisard, and A. Zhukov, <em><a href="https://doi.org/10.1016/j.nima.2020.164829">First Measurement of a 2.5 MeV RFQ Output Emittance with 1 Part-Per-Million Dynamic Range</a></em>, Nuclear Instruments and Methods in Physics Research, Section A: Accelerators, Spectrometers, Detectors and Associated Equipment <strong>987</strong>, (2021).</div>
</div>
<div id="ref-Ruisard_2020" class="csl-entry" role="listitem">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline">K. Ruisard, A. Aleksandrov, S. Cousineau, V. Tzoganis, and A. Zhukov, <em><a href="https://doi.org/10.1103/PhysRevAccelBeams.23.124201">High Dimensional Characterization of the Longitudinal Phase Space Formed in a Radio Frequency Quadrupole</a></em>, Phys. Rev. Accel. Beams <strong>23</strong>, 124201 (2020).</div>
</div>
<div id="ref-Hoover_2022" class="csl-entry" role="listitem">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline">A. Hoover, K. Ruisard, A. Aleksandrov, A. Zhukov, and S. Cousineau, <em><a href="https://doi.org/10.1103/PhysRevAccelBeams.26.064202">Analysis of a Hadron Beam in Five-Dimensional Phase Space</a></em>, Phys. Rev. Accel. Beams <strong>26</strong>, 064202 (2023).</div>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/austin-hoover\.github\.io\/blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="austin-hoover/blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"selector":".lightbox","loop":false,"openEffect":"zoom","descPosition":"bottom","closeEffect":"zoom"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>