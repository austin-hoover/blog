---
title: "The impact of high-dimensional phase space correlations on the beam dynamics in a linear accelerator"
date: 2024-10-07
author: Austin Hoover
categories:
  - entropy
  - tomography
  - mcmc
bibliography: references.bib
csl: ./american-physics-society.csl
lightbox: true
toc: false
draft: true
---

CERN hosted the "68th ICFA Advanced Beam Dynamics Workshop on High-Intensity and High-Brightness Hadron Beams" (HB conference) where I talked about our work at the SNS Beam Test Facility (BTF). The BTF follows in the footsteps of the Low Energy Demonstration Accelerator (LEDA), a project at Los Alamos National Lab around twenty years ago. LEDA was a proton source followed by 50 quadrupole magnets aranged in an alternating focus-defocus pattern (FODO). Their simulations could not reproduce low-density tails, or "halos", in the measured beam profiles at the end of the FODO channel. The following figure shows these attempts for three initial phase space distributions.

![](figures/fig_leda.png)

Halo formation is driven by space charge. Thus, one explanation of the LEDA discrepancy is that the initial 6D phase space distribution was not known. However, errors in the lattice could be equally important. To reproduce halo-level details, one must model a delicate interplay between applied and self-generated fields. 

We're trying to do this in the BTF by emplying novel phase space diagnostics. One of these diagnostics is a direct measurement of the initial six-dimensional phase space distribution @Cathey_2018. We perform this measurement after the beam has been bunched and accelerated to 2.5 MeV in the RFQ (Radio Frequency Quadrupole). The measurement location is called "first emittance station" in the following figure.

![](figures/fig_btf_01.png)

Unfortunately, 6D measurements are *very* slow (24 hours for a single measurement), have low resolution (10 points per dimension), and low dynamic range (cannot image points below 1\% of the peak density). There's another way to generate the initial distribution that avoids a 6D measurement: we could measure the beam before the RFQ. The beam before the RFQ is unbunched, i.e., it is a continuous stream of ions. This means we only need to measure the four phase space dimensions in the transverse plane. However, we then need to track the beam through the RFQ, which involves hundreds of focusing periods and a very complex bunching process with strong space charge.

We don't have any diagnostics to measure the 4D distribution between the source and RFQ. We can, however, measure the 2D distribution at a separate test stand dedicated to ion source R&D. This is a different ion source than in the BTF, but should produce a similar distribution. We can track the beam through the RFQ, then all the way to the first measurement station. This defines what I'll call the "model" bunch, compared to a directly measured bunch at that location.

![](figures/fig_btf_02.png)


## PARMTEQ vs. reality

Now we have access to a fully-correlated 6D bunch, and we never had to perform a 6D measurement. But there's a catch: we have no idea if our RFQ simulation code (PARTMEQ) is any good. Well, we know it gets the basic physics correct, but there are various approximations baked into the model, such as cylindrical symmetry in all space charge calculations. Additionally, PARTMEQ predicted a much higher transmission through the RFQ, giving a 42 mA beam current compared to 26 mA measured. Thus, it would be reasonable to assume that our RFQ model was not generating the correct 6D structure. There's no way to know without a direct measurement.

A year before this conference, we performed 5D measurements of the initial beam, recording the density as a function of $x$, $p_x$, $y$, $p_y$, and $p_z$ @Hoover_2022. The missing dimension, $z$, is strongly correlated with $p_z$, so most features are visible from these variables. 5D measurements are much, much faster because we can image two dimensions at once on a screen (and because there is one less dimension to measure). This means the resolution is greatly improved relative to 6D measurements. Additionally, the dynamic range is much larger because more charge makes it to the measurement screen. 

Thus, we can directly compare the PARMTEQ, or "model/predicted", distribution to the measured distribution in five phase space dimensioins. Here are the 1D and 2D projections, with black representing measured and red representing predicted. (Notation: I use $x' = p_x / p_z$ and $y' = p_y / p_z$, measured in mrad. I also use $w$ instead of $p_z$, where $w = E - E_0$ is the deviation from the design energy.

![](figures/fig_01a.png)

These contours are in logarithmic scale, showing three orders of magnitude in density. This is not a total disaster, but it's pretty bad. Particarly troublesome is the $x$-$p_x$ distribution, which is much wider than measured. However ---here is our first major finding---look what happens after a linear transformation:

![](figures/fig_01b.png)

Much better! I normalized both distributions to identity covariance so that

\begin{equation}
\Sigma = 
\begin{bmatrix}
\langle x^2  \rangle & \langle xp_x   \rangle & \langle xy   \rangle & \langle xp_y   \rangle & \langle x p_z   \rangle \\
\langle xp_x \rangle & \langle p_x^2  \rangle & \langle yp_x \rangle & \langle p_xp_y \rangle & \langle p_x p_z \rangle \\
\langle xy   \rangle & \langle yp_x   \rangle & \langle y^2  \rangle & \langle yp_y   \rangle & \langle y p_z   \rangle \\
\langle xp_y \rangle & \langle p_xp_y \rangle & \langle yp_y \rangle & \langle p_y^2  \rangle & \langle p_y p_z \rangle \\
\langle xp_z \rangle & \langle p_xp_z \rangle & \langle yp_z \rangle & \langle p_yp_z \rangle & \langle p_z^2   \rangle
\end{bmatrix}
=
\begin{bmatrix}
1 & 0 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 \\
0 & 0 & 0 & 0 & 1 
\end{bmatrix}
\end{equation}

(From now on, I'll let $x$, $p_x$, $y$, $p_y$, and $p_z$ refer to these "normalized" coordinates.) This means the distributions are quite similar up to a linear transformation. It means the PARTMEQ model has gotten the nonlinear stuff right, even though it predicts a much higher transmission than the real RFQ.

To e