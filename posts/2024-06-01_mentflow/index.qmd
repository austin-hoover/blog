---
title: "Maximum-entropy phase space tomography using normalizing flows"
date: 2024-06-01
author: Austin Hoover
categories:
  - entropy
  - tomography
bibliography: references.bib
csl: ./american-physics-society.csl
draft: true
---

This post discusses the paper *High-dimensional phase space tomography using normalizing flows*; preprint on [arxiv](). Phase space tomography is a technique to reconstruction a position-momentum distribution from low-dimensional projections. Entropy maximization is a mathematically rigorous technique to incorporate prior information in the reconstruction, providing strong regularization when measurements are sparse. But entropy maximization is difficult to implement when the phase space is high-dimensional. In this paper, we explored the use of generative models, specifically *normalizing flows*, for maximum-entropy phase space tomograpy.


## Indirectly measuring position-momentum distributions

A charged particle beam is a classical system; as such, its state is completely described by the position and momentum of each particle in the beam. If we had perfect knowledge of this state and all external forces acting on the system, we could propagate each particle forward or backward in time by integrating the classical equations of motion. We're usually confident in our ability to integrate these equations, but much less confident in our knowledge of the particle coordinates and external forces.

The position ($x, y, z$) and momentum ($x'$, $y'$, $z'$) coordinates form a six-dimensional *phase space*. We're not interested in the phase space coordinates of individual particles (we can't measure those); rather, we're interested in the phase space *distribution*, or *density*. Specifically, we're interested in the probability density function $\rho(\mathbf{x})$, where $\mathbf{x} = [x, x', y, y', z, z']^T$ is the phase space coordinate vector and 
\begin{equation}\label{eq:norm}\tag{1}
    \int \rho(\mathbf{x}) d\mathbf{x} = 1.
\end{equation}

Measuring the phase space distribution is a major focus in accelerator physics. In a [previous post](../2023-05-28_btf), I described our efforts to measure the distribution directly. Here, we assume we can only measure *projections* of the distribution onto position space. For example, one can measure the 1D distribution $\rho(x)$ by sweeping a conducting wire across the beam and measuring the secondary electrons emitted from the wire at each position. Note that the 1D distribution $\rho(x)$ is really an integral over the hidden momentum coordinates:
\begin{equation}\tag{1}
    \rho(x) = \int \rho(x, x') dx'.
\end{equation}
If we could rotate the phase space distribution, we would obtain 1D projections along different angles in phase space. This is the same problem faced in medical CT, where the detector rotates instead of the distribution. Thus, if we could rotate the phase space distribution, we could apply standard CT algorithms to reconstruct the phase space distribution.

Imagine the beam was placed in a harmonic potential well. A beautiful insight from classical mechanics is that, while particles perform sinusoidal oscillations in position space, they trace a circle in phase space! Thus, measuring $\rho(x)$ at different times would be equivalent to measuring the projection of $\rho(x, x')$ along different angles in phase space. The electromagnetic focusing fields in an accelerator *do not* create a simple harmonic potential. But after some approximations, we can often decouple the motion in the three planes and assume that
\begin{equation}
    \begin{bmatrix}
      x(t) \\ x'(t)
    \end{bmatrix}
    =
    \mathbf{M}
    \begin{bmatrix}
      x(0) \\ x'(0)
    \end{bmatrix},
\end{equation}
where $\mathbf{M}$ is a linear transfer matrix. We can account for the shearing and scaling so that our measurements still amount to projections along different angles in phase space. We can measure the beam at different times by placing wirescanners at different positions along the accelerator lattice. Or we could meaure the beam at one position and vary the upstream optics; both methods update the transfer matrix. Thus, by measuring the spatial density at different locations along the accelerator lattice, or under different focusing optics, we can use any CT algorithm to reconstruct the phase space distribution at any point upstream of the measurements.

The problem becomes *much* more difficult when we consider 6D phase space tomograpy from arbitrary nonlinear phase space transformations. We have to search the space of 6D distribution functions. In 2D, we can course-grain the distribution and search the space of images, but this does not scale well to 6D. A $50 \times 50 \times 50 \times 50 \times 50 \times 50$ grid already has 15 billion cells! The storage requirements for many conventional tomography algorithms are even worse because they have to store a matrix connecting the distribution to its projections. For this reason, even 4D tomography rules out the use of most conventional algorithms.


## Maximum-entropy tomography

Let's table that discussion for now. Another issue is that accelerators restrict the number and quality of measured projections. In medical CT, reconstructions proceed from hundreds of measurements at optimally chosen projection angles. In accelerators, we may be limited to tens of measurements, even as few as three or four in some cases. Furthermore, the measurements may not be optimal. In medical CT, we know that we should space the projection angles evenly over 180 degrees. This is usually not possible in 2D phase space tomography due to accelerator constraints, and in 4D or 6D tomography, we don't even know how to determine the best transformations. 

All this to say: phase space tomography can be severely ill-posed. There can be many distributions consistent with the same data. This problem is already important in 2D, but becomes exponentially worse in 4D and 6D. How should we proceed if we must select a single distribution from the feasible set?

Let's define our problem. Let $\mathbf{x} \in \mathbb{R}^n$ be the phase space coordinates. On each measurement, we transform the phsae space coordinates via a symplectic map $\mathcal{M}_k: \mathcal{R}^n \rightarrow \mathcal{R}^n$:
\begin{equation}
    \mathbf{u}_k = \mathcal{M}_k(\mathbf{x}).
\end{equation}
Then we project the transformed coordiantes onto a lower dimensional plane $\mathbf{u}_{k_\parallel} \in \mathbb{R}^m$.
\begin{equation}
    g(\mathbf{u}_{k_\parallel}) = \int{\rho \left( \mathcal{M}_k^{-1}(\mathbf{u}_k )\right) d\mathbf{u}_{k_\perp}}
\end{equation}

We can derive the form of the maximum-entropy distribution from a new functional. Here's some more text to fill out the line.

\begin{equation}
    \Psi [ 
        \rho(\mathbf{x}), 
        \rho_*(\mathbf{x}), 
        \{ g_k(\mathbf{u}_{k_\parallel}) \}
    ]
    =
    H[\rho(\mathbf{x}), \rho_*(\mathbf{x})]
    + 
    \sum_{k}^{} {
    \int
        \lambda_{k}(\mathbf{u}_{k_\parallel})
        \left(
            g_k(\mathbf{u}_{k_\parallel}) - 
            \int \rho \left( \mathcal{M}_k^{-1}(\mathbf{u}_k) \right) 
            d\mathbf{u}_{k_\perp}
        \right)
        d\mathbf{u}_{k_\parallel}
    }
\end{equation}



## Problems in high-dimensional tomography


Roussel et al. proposed a clever solution called *Generative Phase Space Reconstruction (GPSR). 





