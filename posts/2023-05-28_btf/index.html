<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Austin Hoover">
<meta name="dcterms.date" content="2023-05-28">

<title>High-dimensional phase space measurements – Accelerated Inquiry</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DLC4C8LZFB"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-DLC4C8LZFB', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Accelerated Inquiry</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../notes/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#predicting-halo-formation" id="toc-predicting-halo-formation" class="nav-link active" data-scroll-target="#predicting-halo-formation">1. Predicting halo formation</a></li>
  <li><a href="#high-dimensional-phase-space-measurements" id="toc-high-dimensional-phase-space-measurements" class="nav-link" data-scroll-target="#high-dimensional-phase-space-measurements">2. High-dimensional phase space measurements</a></li>
  <li><a href="#high-dimensional-data-visualization" id="toc-high-dimensional-data-visualization" class="nav-link" data-scroll-target="#high-dimensional-data-visualization">3. High-dimensional data visualization</a></li>
  <li><a href="#ongoing-work" id="toc-ongoing-work" class="nav-link" data-scroll-target="#ongoing-work">4. Ongoing work</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">High-dimensional phase space measurements</h1>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Austin Hoover </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 28, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="predicting-halo-formation" class="level2">
<h2 class="anchored" data-anchor-id="predicting-halo-formation">1. Predicting halo formation</h2>
<p>Linear accelerators (linacs) generate powerful pulsed hadron beams for various applications. Increasing the beam power/intensity by orders of magnitude would benefit particle physics, nuclear physics, condensed matter physics, material science, biology, nuclear engineering, and other fields. Unfortunately, significantly increasing the beam intensity is not possible due to <em>beam loss</em> which occurs when particles hit the walls of the accelerator during their journey. The total lost beam power must be kept below 1 watt (W) per meter to avoid dangerous radiation levels. For a 1 MW beam, this limit corresponds to a fractional loss of <span class="math inline">\(10^{-6}\)</span>.</p>
<p>Simulations struggle to predict the number and location of lost particles. The dynamics in the accelerator are complex, but the situation is perhaps unsurprising for other reasons:</p>
<ol type="1">
<li><p>Accelerators are composed of thousands of components distributed over hundreds of meters. Uncertainties in each component’s position, alignment, amplitude, etc., lead to errors in the applied electromagnetic field at each position.</p></li>
<li><p>The initial distribution of particles in position-momentum space (phase space) is usually unknown.</p></li>
</ol>
<p>These issues make it difficult to predict the low-order moments of the beam distribution, let alone low levels of beam loss. The second issue is critical because of the violent space charge forces that influence the beam evolution, coupling the output to the input phase space distribution<span class="citation" data-cites="Wangler_1998 Batygin_2021">&nbsp;[<a href="#ref-Wangler_1998" role="doc-biblioref">1</a>,<a href="#ref-Batygin_2021" role="doc-biblioref">2</a>]</span>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>Take the Spallation Neutron Source (SNS) as an example. The SNS accelerates negative hydrogen (H-) ions through a 500-meter linac. Hundreds of beam loss monitors (BLMs) record the total number of lost particles as a function of position. Phase space distribution measurements are limited to low-dimensional projections in the low-energy stages (near the boxed region in Fig. 1). Simulations based on these measurements and the accelerator’s design parameters cannot predict the measured beam loss.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/sns.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Fig. 1. The Spallation Neutron Source (SNS) accelerator."><img src="./figures/sns.png" class="img-fluid figure-img" alt="Fig. 1. The Spallation Neutron Source (SNS) accelerator."></a></p>
<figcaption>Fig. 1. The Spallation Neutron Source (SNS) accelerator.</figcaption>
</figure>
</div>
<p>The LEDA (Low Energy Test Accelerator) experiment at Los Alamos National Laboratory attempted to predict halo formation over a much shorter distance<span class="citation" data-cites="Qiang_2002">&nbsp;[<a href="#ref-Qiang_2002" role="doc-biblioref">3</a>]</span>. One-dimensional (1D) density profiles of a low-energy proton beam were measured after a series of focusing quadrupole magnets. Simulations failed to reproduce the low-density “halo” surrounding the beam core — see Fig. 2. The authors attributed the failure to an inaccurate phase space distribution used to seed the simulation. (Only low-order moments of the distribution were measured.)</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/qiang_2002_fig9.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Fig. 2. Vertical beam profile measured in the LEDA experiment[@Qiang_2002]."><img src="./figures/qiang_2002_fig9.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="450" alt="Fig. 2. Vertical beam profile measured in the LEDA experiment&nbsp;[3]."></a></p>
</figure>
</div>
<figcaption>Fig. 2. Vertical beam profile measured in the LEDA experiment<span class="citation" data-cites="Qiang_2002">&nbsp;[<a href="#ref-Qiang_2002" role="doc-biblioref">3</a>]</span>.</figcaption>
</figure>
</div>
</section>
<section id="high-dimensional-phase-space-measurements" class="level2">
<h2 class="anchored" data-anchor-id="high-dimensional-phase-space-measurements">2. High-dimensional phase space measurements</h2>
<p>We are continuing experimental work on halo prediction at the SNS Beam Test Facility (BTF), a recently commissioned replica of the front end of the SNS linac<span class="citation" data-cites="Zhang_2020">&nbsp;[<a href="#ref-Zhang_2020" role="doc-biblioref">4</a>]</span>. A diagram of the BTF is below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/btf2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Fig. 3. The SNS Beam Test Facility (BTF)."><img src="./figures/btf2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="600" alt="Fig. 3. The SNS Beam Test Facility (BTF)."></a></p>
</figure>
</div>
<figcaption>Fig. 3. The SNS Beam Test Facility (BTF).</figcaption>
</figure>
</div>
<p>The beam starts as a slow-moving, continuous stream of H- ions extracted from the plasma source. The low-energy beam transport (LEBT) uses electrostatic focusing to guide the beam to the radiofrequency quadrupole RFQ. The RFQ bunches and accelerates the beam to 2.5 MeV. Each bunch drifts through the medium-energy beam transport (MEBT) and finally through a series of permanent quadrupole magnets arranged in a focusing-off-defocusing-off (FODO) pattern. (If halo formation occured, it would likely be here due to the rapid oscillation of the beam core.)</p>
<p>The apparatus just after the RFQ (blue region) measures the particle density in six-dimensional phase space — three positions (<span class="math inline">\(x\)</span>, <span class="math inline">\(y\)</span>, <span class="math inline">\(z\)</span>) and three momenta (<span class="math inline">\(p_x\)</span>, <span class="math inline">\(p_y\)</span>, <span class="math inline">\(p_z\)</span>), with the <span class="math inline">\(z\)</span> axis parallel to the beam. It works by measuring the charge within a small region <span class="math inline">\(\mathbf{x} \pm \Delta\)</span>, where <span class="math inline">\(\mathbf{x} = [x, p_x, y, p_y, z, p_z]^T\)</span>, scanning <span class="math inline">\(\mathbf{x}\)</span> through the space, and interpolating the data to obtain an estimate of the distribution function <span class="math inline">\(f(\mathbf{x})\)</span>.</p>
<p>The region <span class="math inline">\(\mathbf{x} \pm \Delta\)</span> is selected using slits. First, a horizontal-vertical pair of slits selects a square in the <span class="math inline">\(x\)</span>-<span class="math inline">\(y\)</span> plane. Next, a second pair of slits select <span class="math inline">\(p_x\)</span> and <span class="math inline">\(p_y\)</span> (based on their positions relative to the first slits). The momentum <span class="math inline">\(p_z\)</span> is selected by a vertical slit after a dipole magnet, which bends on-energy particles 90 degrees (faster particles bend less). The last to go is <span class="math inline">\(z\)</span>: The beam passes through a wire, generating an electron beam with the same temporal structure. The electrons are streaked in the transverse plane using an oscillating electric field such that the image of the beam on a screen gives the <span class="math inline">\(z\)</span> distribution.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/measurement.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Fig. 4 Cartoon representing the six-dimensional phase space measurement apparatus."><img src="./figures/measurement.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="500" alt="Fig. 4 Cartoon representing the six-dimensional phase space measurement apparatus."></a></p>
</figure>
</div>
<figcaption>Fig. 4 Cartoon representing the six-dimensional phase space measurement apparatus.</figcaption>
</figure>
</div>
<p>We proceed by scanning the slits in a nested loop and recording the image of the beam on the screen at each setting. Each pixel in the image is the intensity at a point in phase space. This measurement is the first of its kind<span class="citation" data-cites="Cathey_2018">&nbsp;[<a href="#ref-Cathey_2018" role="doc-biblioref">5</a>]</span>.</p>
<p>Once we reconstruct the initial distribution <span class="math inline">\(f(\mathbf{x})\)</span>, we generate a set of phase space coordinates <span class="math inline">\(\{\mathbf{x}_1, \dots \mathbf{x}_n\}\)</span> by sampling from the distribution.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> These coordinates are propagated through a computational accelerator model and compared with measurements at the end of the beamline. Here we sacrifice dimensionality for <em>dynamic range</em> to image the beam halo. Instead of measuring the one-dimensional projections <span class="math inline">\(\{ f(x), f(y) \}\)</span>, we measure two-dimensional projections <span class="math inline">\(\{ f(x, p_x), f(y, p_y) \}\)</span>. We can reach a dynamic range of <span class="math inline">\(10^6\)</span> (the dynamic range in Fig. 2 is between <span class="math inline">\(10^3\)</span> and <span class="math inline">\(10^4\)</span>). This high-dynamic-range measurement is the first of its kind<span class="citation" data-cites="Aleksandrov_2021">&nbsp;[<a href="#ref-Aleksandrov_2021" role="doc-biblioref">6</a>]</span>.</p>
<p>When combined with a detailed model of the accelerator and a well-tested simulation code, we hope these measurements will allow us to predict the halo dynamics in the BTF. Such a prediction would be the first step toward model-based loss prediction in a linear accelerator.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/workflow.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Fig. 5. The SNS-BTF workflow. The phase space distribution f(\mathbf{x}) is interpolated from raw images from high-dimensional scans. Particles are sampled from the distribution and propagated through a computational model of the BTF lattice. The output particle distribution is binned and compared with high-dynamic-range measurements of \{f(x, p_x), f(y, p_y)\} at the end of the beamline. The model is refined until the predictions are correct down to the halo level."><img src="./figures/workflow.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="650" alt="Fig. 5. The SNS-BTF workflow. The phase space distribution f(\mathbf{x}) is interpolated from raw images from high-dimensional scans. Particles are sampled from the distribution and propagated through a computational model of the BTF lattice. The output particle distribution is binned and compared with high-dynamic-range measurements of \{f(x, p_x), f(y, p_y)\} at the end of the beamline. The model is refined until the predictions are correct down to the halo level."></a></p>
</figure>
</div>
<figcaption>Fig. 5. The SNS-BTF workflow. The phase space distribution <span class="math inline">\(f(\mathbf{x})\)</span> is interpolated from raw images from high-dimensional scans. Particles are sampled from the distribution and propagated through a computational model of the BTF lattice. The output particle distribution is binned and compared with high-dynamic-range measurements of <span class="math inline">\(\{f(x, p_x), f(y, p_y)\}\)</span> at the end of the beamline. The model is refined until the predictions are correct down to the halo level.</figcaption>
</figure>
</div>
<p>Our 6D measurements are currently quite slow and fail to capture sharp features in the distribution. Dropping one dimension (<span class="math inline">\(z\)</span>) increases the resolution and dynamic range while capturing most of the significant correlations in the data. The resulting 5D measurement is useful for in-depth examinations of the phase space distribution. I’ve gotten a lot of mileage out of a high-resolution 5D measurement I took in June 2022, which is publically available<span class="citation" data-cites="Hoover_2023_Zenodo">&nbsp;[<a href="#ref-Hoover_2023_Zenodo" role="doc-biblioref">7</a>]</span>. The scan generating over 285,082 images over 18 hours. Fig. 6. shows the change in image brightness as the slits move in and out of the beam core.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/bcm.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Fig. 6. Measured image brightness and beam current out of the RFQ during a 5D measurement."><img src="./figures/bcm.png" class="img-fluid figure-img" width="500" alt="Fig. 6. Measured image brightness and beam current out of the RFQ during a 5D measurement."></a></p>
<figcaption>Fig. 6. Measured image brightness and beam current out of the RFQ during a 5D measurement.</figcaption>
</figure>
</div>
<p>We cropped and downscaled the images to decrease the size of the data set from around 250 gigabytes to 20 gigabytes. Next, we interpolated the pixel intensities to obtain a <span class="math inline">\(69 \times 88 \times 69 \times 65 \times 55\)</span> image of the phase space distribution <span class="math inline">\(f(x, x', y, y', w)\)</span>. Here we use the energy <span class="math inline">\(w\)</span> instead of the momentum <span class="math inline">\(p_z\)</span>. (Also <span class="math inline">\(x'\)</span> and <span class="math inline">\(y'\)</span> are basically the same as <span class="math inline">\(p_x\)</span> and <span class="math inline">\(p_y\)</span>.)</p>
</section>
<section id="high-dimensional-data-visualization" class="level2">
<h2 class="anchored" data-anchor-id="high-dimensional-data-visualization">3. High-dimensional data visualization</h2>
<p>We have spent significant time analyzing the measured initial phase space distribution<span class="citation" data-cites="Cathey_2018 Ruisard_2020 Ruisard_2021 Hoover_2023_PRAB">&nbsp;[<a href="#ref-Cathey_2018" role="doc-biblioref">5</a>,<a href="#ref-Ruisard_2020" role="doc-biblioref">8</a>–<a href="#ref-Hoover_2023_PRAB" role="doc-biblioref">10</a>]</span>. This task is straightforward in two dimensions: one simply looks at an image representing <span class="math inline">\(f(x, p_x)\)</span> and extracts features from it. High-dimensional data is exponentially more challenging to visualize and interpret.</p>
<p>Here it is helpful to distinguish <em>projections</em>, <em>slices</em>, and <em>partial projections</em>. A projection is an integral/sum that squashes the distribution onto a lower-dimensional space. For example: <span class="math display">\[
f(x, p_x) = \iiiint_{-\infty}^{+\infty} {f(x, p_x, y, p_y, z, p_z) dy dp_y dz dp_z}.
\]</span> We must eventually project the distribution onto a two-dimensional space to view it on a page or screen. For an <span class="math inline">\(n\)</span>-dimensional distribution, there are <span class="math inline">\(n\)</span> one-dimensional projections and <span class="math inline">\(n (n - 1) / 2\)</span> two-dimensional projections. The classic corner plot displays all these projections in a single figure.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/corner.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Fig. 7. Corner plot showing the one-dimensional and two-dimensional projections of a measured five-dimensional distribution."><img src="./figures/corner.png" class="img-fluid figure-img" width="550" alt="Fig. 7. Corner plot showing the one-dimensional and two-dimensional projections of a measured five-dimensional distribution."></a></p>
<figcaption>Fig. 7. Corner plot showing the one-dimensional and two-dimensional projections of a measured five-dimensional distribution.</figcaption>
</figure>
</div>
<p>Corner plots are valuable tools, but it is important to remember that they hide relationships between three or more dimensions. Higher dimensional correlations are only visible in <em>slices</em>. Most people are familiar with slices (i.e., cross sections) from three-dimensional medical CT scans. CT scans map the three-dimensional density of, say, a human brain. To examine the brain’s internal structure, medical professionals scroll through a set of two-dimensional images. Each image is the density on a two-dimensional plane intersecting the three-dimensional distribution. We call this a “planar slice”.</p>
<p>Add one more dimension. How is a slice defined now? Well, we could look at the intersection of a three-dimensional plane with the four-dimensional distribution. This is equivalent to fixing the value of one of the coordinates, leaving a conditional distribution like <span class="math inline">\(f(x, p_x, p_y \vert y{=}0)\)</span>. But there is now more than one dimension that we could slice. We could take another three-dimensional plane, orthogonal to the first plane, and view the intersection of both planes and the four-dimensional distribution. We are left with a two-dimensional surface like <span class="math inline">\(f(x, p_x \vert y{=}p_y{=}0)\)</span>.</p>
<p>Since slices can be projected and projections can be sliced, we must distinguish between a full projection and a <em>partial</em> projection — the projection of a slice. More complex slicing/projection sequences are obviously possible in five- or six-dimensional spaces.</p>
<p>The “slice matrix” plot in Fig. 8 is one way to visualize the effect of slicing a four-dimensional distribution. A two-dimensional projection is on the bottom right. Three-dimensional projections — obtained by slicing only one dimension — are on the bottom and right panels. The four-dimensional distribution — obtained by slicing two dimensions — is shown on the top left.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/slice_xp-yp_view_y-w.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Fig. 8. A four-dimensional slice of a measured five-dimensional distribution. Three- and two-dimensional projections are shown on the side panels."><img src="./figures/slice_xp-yp_view_y-w.png" class="img-fluid figure-img" alt="Fig. 8. A four-dimensional slice of a measured five-dimensional distribution. Three- and two-dimensional projections are shown on the side panels."></a></p>
<figcaption>Fig. 8. A four-dimensional slice of a measured five-dimensional distribution. Three- and two-dimensional projections are shown on the side panels.</figcaption>
</figure>
</div>
<p>Such figures render slowly and are limited to four-dimensional data. Complete slicing flexibility is available in an interactive widget shown in Fig. 9. This function takes one or more images or point clouds of any dimensionality as inputs. I use it extensively in my data analysis. It is available in the <a href="https://github.com/austin-hoover/psdist">psdist</a> package.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/slicing.mov" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Fig. 9. Interactive slicing widget from psdist."><video src="./figures/slicing.mov" class="img-fluid quarto-figure quarto-figure-center" width="500" controls=""></video></a><a href="./figures/slicing.mov">Fig. 9. Interactive slicing widget from psdist.</a></p>
</figure>
</div>
<figcaption>Fig. 9. Interactive slicing widget from <code>psdist</code>.</figcaption>
</figure>
</div>
<p>There are other ways to slice and project the data. For example, we could extend the concept of a radial histogram. A radial histogram takes a distribution <span class="math inline">\(f(x_1, \dots, x_n)\)</span> to a one-dimensional profile <span class="math inline">\(f(r_n)\)</span>, where <span class="math inline">\(r_n = \sqrt{x_1^2 + \dots + x_n^2}\)</span>, by integrating the density on spheres of radius <span class="math inline">\(r_n\)</span>.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> Instead of defining the spheres in the <span class="math inline">\(n\)</span>-dimensional space, suppose we defined them in a subspace like the <span class="math inline">\(x_2\)</span>-<span class="math inline">\(\dots\)</span>-<span class="math inline">\(x_n\)</span> plane and observed the <span class="math inline">\(x_1\)</span> distribution on each sphere. In other words, compute <span class="math inline">\(f(x_1, r(x_2, \dots, x_n))\)</span>. The resulting projection is more difficult to interpret but preserves high-dimensional correlations in the data.</p>
<p>We could also define shells as the density contours of the distribution in the subpace — <span class="math inline">\(f(x_2, \dots, x_n)\)</span> in the above example. We could label these “contour shell slices”. Fig. 10 illustrates this concept. I applied this idea to our measured distribution to view a specific feature in a compact figure. In Fig. 11, I defined density contours in the four-dimensional transverse phase space by thresholding the projection <span class="math inline">\(f(x, x', y, y')\)</span> between two density levels. I then computed the energy distribution within each shell (possible thanks to <code>numpy</code>).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/nonplanar.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Fig. 10. Concept of non-planar or “shell” slices."><img src="./figures/nonplanar.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="580" alt="Fig. 10. Concept of non-planar or “shell” slices."></a></p>
</figure>
</div>
<figcaption>Fig. 10. Concept of non-planar or “shell” slices.</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/shell_slice.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Fig. 11. Energy (w) distribution within four-dimensional contour shell slices in the transverse phase space. Each slice is defined by the projected density f(x, x', y, y')."><img src="./figures/shell_slice.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="500" alt="Fig. 11. Energy (w) distribution within four-dimensional contour shell slices in the transverse phase space. Each slice is defined by the projected density f(x, x', y, y')."></a></p>
</figure>
</div>
<figcaption>Fig. 11. Energy (<span class="math inline">\(w\)</span>) distribution within four-dimensional contour shell slices in the transverse phase space. Each slice is defined by the projected density <span class="math inline">\(f(x, x', y, y')\)</span>.</figcaption>
</figure>
</div>
<p>Notice the drastic change in energy distribution — unimodal to bimodal — as we move from the outer to the inner core in the transverse phase space. This energy hollowing represents a five-dimensional correlation; it is also visible (although perhaps harder to see) in Fig. 8. I also plotted the transverse projections of the slice farthest from the core. Pretty bizarre-looking images result, but they make some sense; they select particles with large transverse amplitude. Some intuition is gained by considering the projections of hollow three-dimensional distribution.</p>
</section>
<section id="ongoing-work" class="level2">
<h2 class="anchored" data-anchor-id="ongoing-work">4. Ongoing work</h2>
<p>We would like to explain the origin of all features we find in the distribution. From direct measurements at lower beam currents, we know the space charge drives the energy hollowing in Fig. 10.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./figures/waterfall.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Fig. 11. Sliced energy distribution vs.&nbsp;beam current. Source: Kiersten Ruisard."><img src="./figures/waterfall.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="475" alt="Fig. 11. Sliced energy distribution vs.&nbsp;beam current. Source: Kiersten Ruisard."></a></p>
</figure>
</div>
<figcaption>Fig. 11. Sliced energy distribution vs.&nbsp;beam current. Source: Kiersten Ruisard.</figcaption>
</figure>
</div>
<p>Furthermore, we are confident that the energy hollowing develops in the RFQ rather than the MEBT. I am currently using simulations to study the dynamics that drive the hollowing in the RFQ.</p>
<p>Another (more practical) question is: how do “hidden” features in the initial distribution affect the downstream dynamics? In particular, how do they affect halo formation in the BTF or the SNS linac? I am also studying this problem using simulations.</p>
<p>Improvements to the high-dimensional measurements and the accelerator model will resume when the BTF comes back online this fall.</p>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="0" role="list">
<div id="ref-Wangler_1998" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">T. P. Wangler, K. R. Crandall, R. Ryne, and T. S. Wang, <em><a href="https://doi.org/10.1103/PhysRevSTAB.1.084201">Particle-Core Model for Transverse Dynamics of Beam Halo</a></em>, Phys. Rev. ST Accel. Beams <strong>1</strong>, 084201 (1998).</div>
</div>
<div id="ref-Batygin_2021" class="csl-entry" role="listitem">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">K. Batygin and Y. K. Batygin, <em><a href="https://doi.org/10.1063/5.0056306">Chaotic Dynamics Driven by Particle-Core Interactions</a></em>, Physics of Plasmas <strong>28</strong>, 093104 (2021).</div>
</div>
<div id="ref-Qiang_2002" class="csl-entry" role="listitem">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">J. Qiang, P. L. Colestock, D. Gilpatrick, H. V. Smith, T. P. Wangler, and M. E. Schulze, <em><a href="https://doi.org/10.1103/PhysRevSTAB.5.124201">Macroparticle Simulation Studies of a Proton Beam Halo Experiment</a></em>, Physical Review Special Topics - Accelerators and Beams <strong>5</strong>, 35 (2002).</div>
</div>
<div id="ref-Zhang_2020" class="csl-entry" role="listitem">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">Z. Zhang, S. Cousineau, A. Aleksandrov, A. Menshov, and A. Zhukov, <em><a href="https://doi.org/10.1016/j.nima.2019.162826">Design and Commissioning of the Beam Test Facility at the Spallation Neutron Source</a></em>, Nuclear Instruments and Methods in Physics Research, Section A: Accelerators, Spectrometers, Detectors and Associated Equipment <strong>949</strong>, (2020).</div>
</div>
<div id="ref-Cathey_2018" class="csl-entry" role="listitem">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline">B. Cathey, S. Cousineau, A. Aleksandrov, and A. Zhukov, <em><a href="https://doi.org/10.1103/PhysRevLett.121.064804">First Six Dimensional Phase Space Measurement of an Accelerator Beam</a></em>, Physical Review Letters <strong>121</strong>, (2018).</div>
</div>
<div id="ref-Aleksandrov_2021" class="csl-entry" role="listitem">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline">A. Aleksandrov, S. Cousineau, K. Ruisard, and A. Zhukov, <em><a href="https://doi.org/10.1016/j.nima.2020.164829">First Measurement of a 2.5 MeV RFQ Output Emittance with 1 Part-Per-Million Dynamic Range</a></em>, Nuclear Instruments and Methods in Physics Research, Section A: Accelerators, Spectrometers, Detectors and Associated Equipment <strong>987</strong>, (2021).</div>
</div>
<div id="ref-Hoover_2023_Zenodo" class="csl-entry" role="listitem">
<div class="csl-left-margin">[7] </div><div class="csl-right-inline">A. Hoover, K. Ruisard, A. Aleksandrov, A. Zhukov, and S. Cousineau, <em><a href="https://doi.org/10.5281/zenodo.7517479">High-Resolution Five-Dimensional Phase Space Measurement at the Spallation Neutron Source Beam Test Facility</a></em>, (2023).</div>
</div>
<div id="ref-Ruisard_2020" class="csl-entry" role="listitem">
<div class="csl-left-margin">[8] </div><div class="csl-right-inline">K. Ruisard, A. Aleksandrov, S. Cousineau, V. Tzoganis, and A. Zhukov, <em><a href="https://doi.org/10.1103/PhysRevAccelBeams.23.124201">High Dimensional Characterization of the Longitudinal Phase Space Formed in a Radio Frequency Quadrupole</a></em>, Physical Review Accelerators and Beams <strong>23</strong>, (2020).</div>
</div>
<div id="ref-Ruisard_2021" class="csl-entry" role="listitem">
<div class="csl-left-margin">[9] </div><div class="csl-right-inline">K. Ruisard and A. Aleksandrov, <em><a href="https://doi.org/10.1103/PhysRevAccelBeams.24.014201">Rapid Charge Redistribution Leading to Core Hollowing in a High-Intensity Ion Beam</a></em>, Physical Review Accelerators and Beams <strong>24</strong>, (2021).</div>
</div>
<div id="ref-Hoover_2023_PRAB" class="csl-entry" role="listitem">
<div class="csl-left-margin">[10] </div><div class="csl-right-inline">A. Hoover, K. Ruisard, A. Aleksandrov, A. Zhukov, and S. Cousineau, <em><a href="https://doi.org/10.1103/PhysRevAccelBeams.26.064202">Analysis of a Hadron Beam in Five-Dimensional Phase Space</a></em>, Phys. Rev. Accel. Beams <strong>26</strong>, 064202 (2023).</div>
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Space charge forces arise from the electric field generated by the beam. The strength of space charge forces scales inversely with the beam energy.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Sampling from a high-dimensional distribution is not trivial. We currently use a simple method that treats the distribution as a histogram. I am looking into approaches that will scale to high-dimensional distribution functions, such as normalizing flows.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>One could just as well define ellipsoids instead of spheres by computing the covariance matrix <span class="math inline">\(\mathbf{\Sigma} = \mathbf{x}\mathbf{x}^T\)</span> and setting <span class="math inline">\(r = \mathbf{x}^T \mathbf{\Sigma}^{-1} \mathbf{x}\)</span>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/austin-hoover\.github\.io\/blog\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="austin-hoover/blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","selector":".lightbox","openEffect":"zoom","loop":false});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>